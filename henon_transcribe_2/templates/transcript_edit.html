{% extends "base.html" %}

{% block title %}Transcript{% endblock %}

{% block content %}
<div style="position: fixed; top: 40px; z-index: 100; width: 100%; background: #fff;">
  <audio controls id="recording" src="/{{transcript.recording_filepath}}" type="audio/mpeg"></audio>
</div>

<div style="margin-top: 75px;">
  <table class="edit-table" border="1"></table>
</div>

<script>
  function playAudioSection(startTime, endTime) {
    var audio = document.getElementById('recording');
    audio.pause();
    audio.currentTime = startTime;
    audio.play();
    audio.ontimeupdate = function() {
        if (audio.currentTime >= endTime) {
            audio.pause();
            audio.ontimeupdate = null;
        }
    };
  }

  function updateSegmentTranscript(segmentId) {
      var segmentElement = document.getElementById('segment_' + segmentId);
      var newTranscript = segmentElement.innerText;
      fetch('/transcript/{{transcript.slug}}/edit/segment/text/update/' + segmentId, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ "new_transcript": newTranscript }),
      })
      .then(response => response.json())
      .then(data => {
        showToast('Update successful!');
        redrawTable();
      })
      .catch((error) => {
        console.error('Error:', error);
      });
  }

  function resetSegmentTranscript(segmentId) {
      fetch('/transcript/{{transcript.slug}}/edit/segment/text/reset/' + segmentId, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
      })
      .then(response => response.json())
      .then(data => {
        showToast('Reset successful!');
        redrawTable();
      })
      .catch((error) => {
        console.error('Error:', error);
      });
  }

  function showToast(message) {
      var toast = document.createElement('div');
      toast.setAttribute('class', 'toast');
      toast.innerText = message;
      document.body.appendChild(toast);
      setTimeout(() => {
          toast.remove();
      }, 2000);
  }

  function redrawTable() {
    fetch('/transcript/{{transcript.slug}}/table/html')
      .then(response => response.text())
      .then(html => {
    document.querySelector('.edit-table').innerHTML = html;
    });
  }

  window.onload = function() {
    redrawTable();

    // Handler for editable cells
    document.querySelector('.edit-table').addEventListener('keydown', function(event) {
        let td = event.target;
        if (td.matches('td[contenteditable=true]')) {
            if ((event.ctrlKey || event.metaKey) && (event.key === 'Enter' || event.keyCode === 13)) {
                event.preventDefault();
                let segment_id = td.id.replace('segment_', '');
                let new_text = td.textContent;
                updateSegmentTranscript(segment_id, new_text);
            }
        }
    });

    // Handler for merge buttons
    document.querySelector('.edit-table').addEventListener('click', function(event) {
        let button = event.target;
        if (button.matches('.merge-button')) {
            event.preventDefault();
            let segmentId = button.dataset.id;
            fetch(`/transcript/{{transcript.slug}}/edit/segment/merge/${segmentId}`, {
                method: 'POST',
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                redrawTable();
                showToast('Segment merge successful!');
            })
            .catch(error => {
                console.error('There has been a problem with your fetch operation:', error);
            });
        }
        // Handler for remove merge buttons
        else if (button.matches('.remove-merge-button')) {
            event.preventDefault();
            let segmentId = button.dataset.id;
            fetch(`/transcript/{{transcript.slug}}/edit/segment/unmerge/${segmentId}`, {
                method: 'POST',
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                redrawTable();
                showToast('Segment unmerge successful!');
            })
            .catch(error => {
                console.error('There has been a problem with your fetch operation:', error);
            });
        }
    });
  };

</script>

{% endblock %}